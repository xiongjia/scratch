cmake_minimum_required(VERSION 3.8.0)

include(ExternalProject)

# Boost
unset(Boost_LIBRARIES)
set(Boost_USE_STATIC ON)
set(Boost_USE_STATIC_LIBS ON)
set(Boost_USE_MULTITHREADED ON)
set(Boost_USE_STATIC_RUNTIME ON)
find_package(Boost REQUIRED COMPONENTS
  unit_test_framework thread date_time
  system chrono filesystem regex)

# zlib
ExternalProject_Add(
  zlib
  GIT_REPOSITORY "https://github.com/madler/zlib.git"
  GIT_TAG "master"
  UPDATE_COMMAND ""
  PATCH_COMMAND ""
  SOURCE_DIR "${CMAKE_SOURCE_DIR}/deps/zlib"
  CMAKE_ARGS
    -DCMAKE_INSTALL_PREFIX=${PROJECT_BINARY_DIR}/zlib
    -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
    -DCMAKE_CXX_FLAGS_DEBUG=${CMAKE_CXX_FLAGS_DEBUG}
    -DCMAKE_CXX_FLAGS_RELEASE=${CMAKE_CXX_FLAGS_RELEASE}
    -DCMAKE_CXX_FLAGS_MINSIZEREL=${CMAKE_CXX_FLAGS_MINSIZEREL}
    -DCMAKE_CXX_FLAGS_RELWITHDEBINFO=${CMAKE_CXX_FLAGS_RELWITHDEBINFO}
    -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
    -DCMAKE_C_FLAGS_DEBUG=${CMAKE_C_FLAGS_DEBUG}
    -DCMAKE_C_FLAGS_RELEASE=${CMAKE_C_FLAGS_RELEASE}
    -DCMAKE_C_FLAGS_MINSIZEREL=${CMAKE_C_FLAGS_MINSIZEREL}
    -DCMAKE_C_FLAGS_RELWITHDEBINFO=${CMAKE_C_FLAGS_RELWITHDEBINFO}
  TEST_COMMAND ""
)

ExternalProject_Add_Step(
  zlib CopyToBin
  DEPENDEES install
)

set(ZLIB_INCLUDE_DIRS "${PROJECT_BINARY_DIR}/zlib/include")

string(CONCAT ZLIB_STATIC_DBG_LIBRARIES
  "${PROJECT_BINARY_DIR}/zlib/lib/"
  "${CMAKE_STATIC_LIBRARY_PREFIX}"
  "zlibstaticd"
  "${CMAKE_STATIC_LIBRARY_SUFFIX}")

string(CONCAT ZLIB_STATIC_REL_LIBRARIES
  "${PROJECT_BINARY_DIR}/zlib/lib/"
  ${CMAKE_STATIC_LIBRARY_PREFIX}
  "zlibstatic"
  ${CMAKE_STATIC_LIBRARY_SUFFIX})

# nghttp2
ExternalProject_Add(
  nghttp2
  GIT_REPOSITORY "https://github.com/nghttp2/nghttp2.git"
  GIT_TAG "master"
  UPDATE_COMMAND ""
  PATCH_COMMAND ""
  SOURCE_DIR "${CMAKE_SOURCE_DIR}/deps/nghttp2"
  CMAKE_ARGS
    -DCMAKE_INSTALL_PREFIX=${PROJECT_BINARY_DIR}/nghttp2
    -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
    -DCMAKE_CXX_FLAGS_DEBUG=${CMAKE_CXX_FLAGS_DEBUG}
    -DCMAKE_CXX_FLAGS_RELEASE=${CMAKE_CXX_FLAGS_RELEASE}
    -DCMAKE_CXX_FLAGS_MINSIZEREL=${CMAKE_CXX_FLAGS_MINSIZEREL}
    -DCMAKE_CXX_FLAGS_RELWITHDEBINFO=${CMAKE_CXX_FLAGS_RELWITHDEBINFO}
    -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
    -DCMAKE_C_FLAGS_DEBUG=${CMAKE_C_FLAGS_DEBUG}
    -DCMAKE_C_FLAGS_RELEASE=${CMAKE_C_FLAGS_RELEASE}
    -DCMAKE_C_FLAGS_MINSIZEREL=${CMAKE_C_FLAGS_MINSIZEREL}
    -DCMAKE_C_FLAGS_RELWITHDEBINFO=${CMAKE_C_FLAGS_RELWITHDEBINFO}
  TEST_COMMAND ""
)

ExternalProject_Add_Step(
  nghttp2 CopyToBin
  COMMAND ${CMAKE_COMMAND} -E copy_directory ${PROJECT_BINARY_DIR} ${GLOBAL_OUTPUT_PATH}
  DEPENDEES install
)

